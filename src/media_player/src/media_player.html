<!DOCTYPE HTML>

<head>
	<style>
		html {
			background: #000;
		} * {
			cursor: none !important;
			overflow: hidden;
			margin: 0;
			padding: 0;
		}
	</style>

	<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
	
	<script>
	var socket;
	
	var currentPlayer = "video_0";
	var currentVideos = [];
	var currentVideosIndex = -1;
	var newVideosSended = false;
	var passedCurrentTime = 0.;
	var mediaPlayerClientInitialized = false;
	
	function init() {
		$('#video_0').on('canplay', handleVideoLoaded);
		$('#video_0').on('timeupdate', handleVideoTimeUpdate);
		$('#video_1').on('canplay', handleVideoLoaded);
		$('#video_1').on('timeupdate', handleVideoTimeUpdate);
		
		connect();
	}
	
	function handleVideoLoaded(event) {
		var player = document.getElementById(currentPlayer);
		
		if (newVideosSended) {
			newVideosSended = false;
			
			switchPlayersVisibility();
		}
	}
	
	function handleVideoTimeUpdate(event) {
		if ($(this).attr("id") == currentPlayer && this.currentTime >= this.duration - 1) {
			loadVideo(getNextVideosIndex());
		}
		 
		if (this.currentTime >= this.duration) {
			playCurrentVideo();
		}
		
		if (this.currentTime >= this.duration) {
			passedCurrentTime += this.duration;
		}
	}
	
	function updateRosTime(rosTime) {
		/*if (this.currentTime < this.duration && this.currentTime < this.duration - 1 && this.currentTime > .5) {
			//log("currentTime:" + currentVideosIndex.toString() + ";" + (this.currentTime + passedCurrentTime).toString());
			
			log(rosTime);
		}*/
		//TODO: CONTINUER ICI
	}
	
	function switchPlayersVisibility() {
		$('#' + currentPlayer).css('display', 'block');
		$('#' + getOtherPlayer()).css('display', 'none');
	}
	
	function playVideos(videos) {
		newVideosSended = true;
		passedCurrentTime = 0.;
		
		currentVideos = videos;
		
		loadVideo(0);
		playCurrentVideo();
	}
	
	function loadVideo(videosIndex) {
		currentVideosIndex = videosIndex;
		currentPlayer = getOtherPlayer();
		
		if (currentVideosIndex != -1) {
			document.getElementById(currentPlayer).src = currentVideos[videosIndex];
		}
	}
	
	function playCurrentVideo() {
		if (currentVideosIndex != -1) {
			var player = document.getElementById(currentPlayer);
			player.play();
			
			if (! newVideosSended) {
				switchPlayersVisibility();
			}
        }
        
		document.getElementById(getOtherPlayer()).pause();
	}
	
	function pauseCurrentVideo() {
		var player = document.getElementById(currentPlayer);
		player.pause();
	}
	
	function getOtherPlayer() {
		return currentPlayer == "video_0" ? "video_1" : "video_0";
	}
	
	function getNextVideosIndex() {
		return currentVideosIndex >= currentVideos.length - 1 ? -1 : currentVideosIndex + 1;
	}
	
	function log(message) {
		document.getElementById("log").innerHTML = message;
	}
	
	function connect() {
		var url = "ws://127.0.0.1:9001";
		
		socket = new WebSocket(url);
		
		log('status: connecting to "' + url + '" ...');
		
		socket.onopen = function (event) {
			log('status: connected to "' + socket.url + '"');
			
			if (! mediaPlayerClientInitialized) {
				send('media_player_client_initialized');
				mediaPlayerClientInitialized = true;
			}
		};
		
		socket.onmessage = function (event) {
			message = event.data
			log('received: ' + message);
			if (message.indexOf("javascript:") == 0) {
				log(message.substring(11));
				eval(message.substring(11));
			} else if (message.indexOf("medias:") == 0) {
				log(message.substring(7));
				playVideos(message.substring(7).split(";;;"));
			} else if (message == "pause") {
				log("pause");
				pauseCurrentVideo();
			} else if (message.indexOf("rosTime:") == 0) {
				updateRosTime(parseFloat(message.substring(8)));
			}
		};
		
		socket.onerror = function (event) {
			log('error' + event.code.toString());
		}
		
		socket.onclose = function (event) {
			log('status: disconnected (code: ' + event.code.toString() + ')');
		};
	}
	
	function disconnect() {
		if (socket) {
			log('status: disconnecting');
			socket.close();
		} else {
			log('not connected');
		}
	}
	
	function send(message) {
		if (socket) {
			socket.send(message);
			log('sent: ' + message);
		} else {
			log('can\'t send message because not connected');
		}
	}
	</script>
</head>

<body onload="javascript: init();">
	<div id="log" style="background: red;"></div>
	<div id="videoContainer">
		<video id="video_0" width="100%" height="100%" type="video/mp4">
		</video>
		<video id="video_1" width="100%" height="100%" style="display: none;" type="video/mp4">
		</video>
	</div>
</body>